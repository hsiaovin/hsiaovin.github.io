<body>
  <!DOCTYPE html>
<html lang="en-us">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="" name="keywords">
<meta content="LevelDB源码 -- Cache - 肖文" property="og:title">
<title>LevelDB源码 -- Cache | 肖文</title>
<link rel="stylesheet" href="http://hsiaovin.github.io//css/style.css">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">


  <section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://hsiaovin.github.io//"><h1 class="title is-2">肖文</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/hsiaovin">
            <span class="icon">
              <i class="fa fa-user-circle-o"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://hsiaovin@yeah.net">
            <span class="icon">
              <i class="fa fa-envelope"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://github.com/hsiaovin">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

  <section class="section">
    <div class="container">
      <h2 class="subtitle is-6">2017-8-6</h2>
      <h1 class="title">LevelDB源码 -- Cache</h1>
      
      <div class="content">
        <p>LevelDB的缓存实现。内部实现的LRUCache。
</p>

<p><strong>Cache接口</strong></p>

<pre><code>class Cache {
public:
    Cache() { }
    virtual ~Cache();

    struct Handle { };

    virtual Handle* Insert(const Slice&amp; key, void* value, size_t charge,
                           void (*deleter)(const Slice&amp; key, void* value)) = 0;
    virtual Handle* Lookup(const Slice&amp; key) = 0;
    virtual void Release(Handle* handle) = 0;
    virtual void* Value(Handle* handle) = 0;
    virtual void Erase(const Slice&amp; key) = 0;
    virtual uint64_t NewId() = 0;
    virtual void Prune() {}
    virtual size_t TotalCharge() const = 0;

private:
    void LRU_Remove(Handle* e);
    void LRU_Append(Handle* e);
    void Unref(Handle* e);

    struct Rep;
    Rep* rep_;

    // No copying allowed
    Cache(const Cache&amp;);
    void operator=(const Cache&amp;);
};
</code></pre>

<h3 id="lru缓存算法的实现">LRU缓存算法的实现</h3>

<p><strong>单条缓存记录</strong></p>

<pre><code>struct LRUHandle {
    void* value;
    void (*deleter)(const Slice&amp;, void* value);
    LRUHandle* next_hash;
    LRUHandle* next;
    LRUHandle* prev;
    size_t charge;
    size_t key_length;
    bool in_cache;
    uint32_t refs;
    uint32_t hash;
    char key_data[1];

    Slice key() const {
        // For cheaper lookups, we allow a temporary Handle object
        // to store a pointer to a key in &quot;value&quot;.
        if (next == this) {
            return *(reinterpret_cast&lt;Slice*&gt;(value));
        } else {
            return Slice(key_data, key_length);
        }
    }
};
</code></pre>

<p><strong>哈希表的实现：HandleTable</strong></p>

<pre><code>class HandleTable {
public:
    HandleTable() : length_(0), elems_(0), list_(NULL) { Resize(); }
    ~HandleTable() { delete[] list_; }

    LRUHandle* Lookup(const Slice&amp; key, uint32_t hash) {
        return *FindPointer(key, hash);
    }

    LRUHandle* Insert(LRUHandle* h) {
        LRUHandle** ptr = FindPointer(h-&gt;key(), h-&gt;hash);
        LRUHandle* old = *ptr;
        h-&gt;next_hash = (old == NULL ? NULL : old-&gt;next_hash);
        *ptr = h;
        if (old == NULL) {
            ++elems_;
            if (elems_ &gt; length_) {
                Resize();
            }
        }
        return old;
    }

    LRUHandle* Remove(const Slice&amp; key, uint32_t hash) {
        LRUHandle** ptr = FindPointer(key, hash);
        LRUHandle* result = *ptr;
        if (result != NULL) {
            *ptr = result-&gt;next_hash;
            --elems_;
        }
        return result;
    }

private:
    uint32_t length_;
    uint32_t elems_;
    LRUHandle** list_;

    LRUHandle** FindPointer(const Slice&amp; key, uint32_t hash) {
        LRUHandle** ptr = &amp;list_[hash &amp; (length_ - 1)];
        while (*ptr != NULL &amp;&amp;
                ((*ptr)-&gt;hash != hash || key != (*ptr)-&gt;key())) {
            ptr = &amp;(*ptr)-&gt;next_hash;
        }
        return ptr;
    }

    void Resize() {
        uint32_t new_length = 4;
        while (new_length &lt; elems_) {
            new_length *= 2;
        }
        LRUHandle** new_list = new LRUHandle*[new_length];
        memset(new_list, 0, sizeof(new_list[0]) * new_length);
        uint32_t count = 0;
        for (uint32_t i = 0; i &lt; length_; i++) {
            LRUHandle* h = list_[i];
            while (h != NULL) {
                LRUHandle* next = h-&gt;next_hash;
                uint32_t hash = h-&gt;hash;
                LRUHandle** ptr = &amp;new_list[hash &amp; (new_length - 1)];
                h-&gt;next_hash = *ptr;
                *ptr = h;
                h = next;
                count++;
            }
        }
        assert(elems_ == count);
        delete[] list_;
        list_ = new_list;
        length_ = new_length;
    }
};
</code></pre>
      </div>
    </div>
  </section>
  

  <section class="section">
  <div class="container has-text-centered">
    <p></p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


</body>
